# Runs the dbt pipeline against a new dataset, then creates a preview build in Hashboard.
name: hashboard-preview

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches: [demo/pizzaBytesNoDbt]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  create-preview:
    name: "Hashboard validate & preview"
    concurrency:
      group: preview-${{ github.event.pull_request.number || github.ref }}
      cancel-in-progress: true
    runs-on: ubuntu-latest
    if: ${{ !github.event.pull_request.merged }}

    steps:
      - uses: actions/checkout@v3

      - name: "Install Python 3.9"
        id: install-python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9.16"

      - name: "Install dependencies"
        run: |
          pip install --pre hashboard-cli

      - name: Create Hashboard build
        id: create-hb-build
        env:
          HASHBOARD_PROJECT_ID: ${{ secrets.HASHBOARD_PROJECT_ID }}
          HASHBOARD_ACCESS_KEY_ID: ${{ secrets.HASHBOARD_ACCESS_KEY_ID }}
          HASHBOARD_SECRET_ACCESS_KEY_TOKEN: ${{ secrets.HASHBOARD_ACCESS_KEY_TOKEN }}
        run: |
          hb build  --dbt-artifacts=./ci_artifacts | tee out.txt
          EXIT_CODE=${PIPESTATUS[0]}

          RESULT=$(cat out.txt | sed 's/`//g')
          EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
          echo "log<<$EOF" >> $GITHUB_OUTPUT
          echo "$RESULT" >> $GITHUB_OUTPUT
          echo "$EOF" >> $GITHUB_OUTPUT
          echo "exitCode=$EXIT_CODE" >> $GITHUB_OUTPUT

      - uses: actions/github-script@v6
        name: "Comment on the pull request"
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${{ steps.generate-preview.outputs.result }}`
            })

      - id: set-appropriate-exit-code
        name: "Set exit code"
        run: echo ${{ steps.generate-preview.outputs.result }} | grep succeeded
